<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Caja - GastroPOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        /* DEFINICI√ìN DE VARIABLES (TEMA OSCURO POR DEFECTO) */
        :root { 
            --bg-deep: #0f1115; 
            --card-bg: rgba(20,20,20,0.6); 
            --neon-green: #00f260; 
            --neon-cyan: #0575e6; 
            --text: #e0e0e0; 
            --input-bg: #0f1115;
            --border-color: #333;
            --modal-bg: #1a1a1a;
            --ticket-border: rgba(16,185,129,0.3);
        }

        /* TEMA CLARO (OVERRIDE) */
        body.light-mode {
            --bg-deep: #f3f4f6;
            --card-bg: #ffffff;
            --neon-green: #059669; /* Verde m√°s oscuro para contraste */
            --neon-cyan: #0284c7;
            --text: #1f2937;
            --input-bg: #ffffff;
            --border-color: #d1d5db;
            --modal-bg: #ffffff;
            --ticket-border: #d1d5db;
        }

        /* Ajustes espec√≠ficos para inputs en modo claro */
        body.light-mode input, body.light-mode select {
            color: #1f2937;
            border: 1px solid #d1d5db;
        }
        body.light-mode .ticket {
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        body { font-family:'Poppins',sans-serif; background:var(--bg-deep); color:var(--text); padding:30px; margin:0; transition: 0.3s; }
        
        h1 { font-family:'Orbitron'; color:var(--neon-green); margin:0; }
        
        .ticket { background:var(--card-bg); border:1px solid var(--ticket-border); border-radius:16px; padding:20px; margin-bottom:20px; transition:0.3s; position: relative; }
        .ticket:hover { border-color:var(--neon-green); transform:translateY(-5px); }
        
        .item-list { background:rgba(0,0,0,0.1); border-radius:8px; padding:10px; margin:10px 0; max-height:150px; overflow-y:auto; font-size:0.85rem; color:var(--text); opacity: 0.8; }
        .item-row { display:flex; justify-content:space-between; border-bottom:1px dashed var(--border-color); padding:4px 0; }
        
        .btn-pay { background:linear-gradient(90deg,var(--neon-green),#0575e6); border:none; color:#fff; font-weight:800; padding:10px; border-radius:6px; width:100%; cursor:pointer; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); align-items:center; justify-content:center; z-index:999; backdrop-filter: blur(5px); }
        .modal-content { background:var(--modal-bg); border:1px solid var(--neon-green); padding:30px; border-radius:20px; width:450px; color:var(--text); box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        
        input, select { background:var(--input-bg); border:1px solid var(--border-color); color:var(--text); padding:10px; border-radius:8px; width:100%; box-sizing:border-box; margin-bottom:10px; outline:none; }
    </style>
</head>
<body>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px">
        <div style="display:flex; gap:10px; align-items:center"><span class="material-icons-round" style="color:var(--neon-green);font-size:35px">point_of_sale</span> <h1>CAJA</h1></div>
        <div style="display:flex; gap:10px; align-items:center;">
            
            <button onclick="toggleTheme()" style="background:var(--card-bg); border:1px solid var(--border-color); color:var(--text); padding:10px; border-radius:50%; cursor:pointer; width:45px; height:45px; display:flex; align-items:center; justify-content:center; margin-right:10px">
                <span class="material-icons-round" id="theme-icon">light_mode</span>
            </button>

            <button onclick="abrirArqueo()" style="background:var(--card-bg); color:var(--text); border:1px solid var(--border-color); padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold">üí∞ Cierre</button>
            <button onclick="logout()" style="border:1px solid #ef4444; background:none; color:#ef4444; padding:10px 20px; border-radius:8px; cursor:pointer">Salir</button>
        </div>
    </div>
    
    <div id="container" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(350px,1fr)); gap:20px"></div>

    <div id="modal-pago" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0">Cobrar</h2>
            <div style="text-align:center; margin:20px 0;">
                <div style="font-size:3rem; font-family:'Orbitron'; color:var(--neon-green)">$<span id="lbl-total">0</span></div>
            </div>
            
            <div style="display:flex; gap:10px; background:rgba(128,128,128,0.1); padding:10px; border-radius:8px; margin-bottom:15px">
                <input type="checkbox" id="chk-factura" onclick="toggleFactura()" style="width:auto"> <label>Factura Electr√≥nica</label>
            </div>
            <div id="sec-factura" style="display:none">
                <div style="display:flex; gap:10px"><input id="f-nit" placeholder="NIT"><input id="f-tel" placeholder="Tel√©fono"></div>
                <input id="f-nombre" placeholder="Nombre"><input id="f-email" placeholder="Email">
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px">
                <div><label style="font-size:0.7rem">M√âTODO</label><select id="f-metodo"><option>Efectivo</option><option>Tarjeta</option><option>Nequi</option></select></div>
                <div><label style="font-size:0.7rem">DTO %</label><input type="number" id="f-desc" value="0" min="0" max="100" onchange="calcTotal()"></div>
                <div><label style="font-size:0.7rem">PROPINA</label><input type="number" id="f-prop" value="0" onchange="calcTotal()"></div>
            </div>

            <button class="btn-pay" onclick="confirmarPago()">CONFIRMAR PAGO</button>
            <button onclick="imprimirPreCuenta()" style="background:none; border:1px dashed var(--text); color:var(--text); opacity:0.7; width:100%; padding:10px; margin-top:10px; cursor:pointer; border-radius:6px">üñ®Ô∏è Imprimir Ticket</button>
            <button onclick="document.getElementById('modal-pago').style.display='none'" style="background:none; border:none; color:var(--text); opacity:0.5; width:100%; margin-top:10px; cursor:pointer">Cancelar</button>
        </div>
    </div>

    <div id="modal-arqueo" class="modal">
        <div class="modal-content">
            <h2>Cierre de Caja</h2>
            <p>Dinero F√≠sico en Caj√≥n:</p>
            <input type="number" id="arq-fisico" placeholder="Total contado">
            <button class="btn-pay" onclick="calcularArqueo()">COMPARAR</button>
            <div id="arq-result" style="margin-top:20px; padding:15px; background:rgba(128,128,128,0.1); border-radius:8px; display:none">
                <p>Sistema: <b id="sys-total">$0</b></p>
                <p>Diferencia: <b id="dif-total" style="font-size:1.2rem">$0</b></p>
            </div>
            <button onclick="document.getElementById('modal-arqueo').style.display='none'" style="background:none; border:none; color:var(--text); opacity:0.5; width:100%; margin-top:10px; cursor:pointer">Cerrar</button>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        checkAuth();
        // Al cargar, inicializamos el tema
        // (Nota: api.js ya tiene el listener, pero lo llamamos manualmente por seguridad si se carga din√°mico)
        if(window.initTheme) initTheme();

        let ventaActual=null, itemsACobrar=[], montoBase=0;

        async function cargar(){
            const res=await apiFetch('/ventas/');
            const div=document.getElementById('container');
            if(res){
                const list=(res.data||res).filter(v=>v.estado==='por_cobrar'||v.estado==='entregado');
                div.innerHTML=list.length?'':'<div style="grid-column:1/-1;text-align:center;opacity:0.5;margin-top:50px">Caja Cerrada (Sin pendientes)</div>';
                list.forEach(v=>{
                    let html=`<div class="mesa-title"><span>${v.mesa}</span> <small style="opacity:0.7">$${v.total.toLocaleString('es-CO')}</small></div>`;
                    if(v.tipo_cuenta==='separada'){
                        const gr={}; v.detalles.forEach(d=>{const n=d.comensal||'Mesa'; if(!gr[n])gr[n]={t:0,i:[]}; gr[n].t+=d.subtotal; gr[n].i.push(d)});
                        html+=`<div style="font-size:0.8rem;color:var(--neon-cyan);margin-bottom:10px">CUENTAS SEPARADAS</div>`;
                        for(const[n,d]of Object.entries(gr)){
                            const desc=d.i.map(x=>`<div>${x.cantidad} ${x.producto_nombre}</div>`).join('');
                            html+=`<div style="background:rgba(128,128,128,0.1);padding:10px;margin-bottom:5px;border-radius:8px;border-left:3px solid var(--neon-cyan)">
                                <div style="display:flex;justify-content:space-between"><b>${n}</b><b style="color:var(--neon-green)">$${d.t.toLocaleString('es-CO')}</b></div>
                                <div style="font-size:0.8rem;opacity:0.7;margin:5px 0">${desc}</div>
                                <button class="btn-pay" style="padding:5px;font-size:0.8rem" onclick='initPay(${JSON.stringify(v)},${d.t},${JSON.stringify(d.i.map(x=>x.id))},"${n}")'>Cobrar</button>
                            </div>`;
                        }
                    } else {
                        const all=v.detalles.map(x=>`<div class="item-row"><span>${x.cantidad} ${x.producto_nombre}</span><span>$${x.subtotal.toLocaleString('es-CO')}</span></div>`).join('');
                        html+=`<div class="item-list">${all}</div><button class="btn-pay" onclick='initPay(${JSON.stringify(v)},${v.total},[],"Mesa")'>COBRAR TOTAL</button>`;
                    }
                    const c=document.createElement('div'); c.className='ticket'; c.innerHTML=html; div.appendChild(c);
                });
            }
        }

        function initPay(v,m,ids,nom){
            ventaActual=v; montoBase=m; itemsACobrar=ids;
            document.getElementById('lbl-total').innerText=m.toLocaleString('es-CO');
            document.getElementById('f-nombre').value=nom!=='Mesa'?nom:'';
            document.getElementById('f-desc').value=0; document.getElementById('f-prop').value=0;
            document.getElementById('chk-factura').checked=false; toggleFactura();
            document.getElementById('modal-pago').style.display='flex';
        }
        function toggleFactura(){document.getElementById('sec-factura').style.display=document.getElementById('chk-factura').checked?'block':'none';}
        
        function calcTotal(){
            const d=parseFloat(document.getElementById('f-desc').value)||0;
            const p=parseFloat(document.getElementById('f-prop').value)||0;
            const sub = montoBase - (montoBase*d/100);
            document.getElementById('lbl-total').innerText=(sub+p).toLocaleString('es-CO');
        }

        async function confirmarPago(){
            const fact=document.getElementById('chk-factura').checked;
            const payload={
                metodo_pago:document.getElementById('f-metodo').value,
                propina:parseFloat(document.getElementById('f-prop').value)||0,
                descuento:parseFloat(document.getElementById('f-desc').value)||0,
                cliente_nit:fact?document.getElementById('f-nit').value:"222222222222",
                cliente_nombre:fact?document.getElementById('f-nombre').value:"Consumidor Final",
                cliente_email:document.getElementById('f-email').value,
                cliente_telefono:document.getElementById('f-tel').value,
                items_a_pagar:itemsACobrar
            };
            await apiFetch(`/ventas/${ventaActual.id}/pagar_v2`,'PUT',payload);
            document.getElementById('modal-pago').style.display='none'; cargar();
        }

        function imprimirPreCuenta(){
            const win=window.open('','','width=300,height=400');
            win.document.write(`<pre style="font-family:monospace">
GASTRO POS - PRE CUENTA
-----------------------
Mesa: ${ventaActual.mesa}
Cliente: ${document.getElementById('f-nombre').value||'xxxxx'}
-----------------------
Total Base: $${montoBase.toLocaleString('es-CO')}
-----------------------
Gracias por su visita
</pre>`);
            win.print();
        }

        function abrirArqueo() {
            document.getElementById('modal-arqueo').style.display = 'flex';
            document.getElementById('arq-fisico').value = '';
            document.getElementById('arq-result').style.display = 'none';
        }

        async function calcularArqueo(){
            const r=await apiFetch('/ventas/reporte/resumen');
            const sis=r.total_caja; const fis=parseFloat(document.getElementById('arq-fisico').value)||0;
            const dif=fis-sis;
            document.getElementById('sys-total').innerText=`$${sis.toLocaleString('es-CO')}`;
            document.getElementById('dif-total').innerText=`$${dif.toLocaleString('es-CO')}`;
            document.getElementById('dif-total').style.color=dif>=0?'var(--neon-green)':'#ff4444';
            document.getElementById('arq-result').style.display='block';
        }

        function logout(){localStorage.clear();window.location.href='login.html';}
        setInterval(cargar,5000); cargar();
    </script>
</body>
</html>