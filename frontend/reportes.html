<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reportes - The Oracle</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
    
    <style>
        :root { --bg-deep: #09090b; --glass: rgba(255, 255, 255, 0.03); --glass-border: rgba(255, 255, 255, 0.1); --text: #e4e4e7; --primary: #8b5cf6; --input-bg: rgba(0,0,0,0.3); --danger: #ef4444; --success: #10b981; --warning: #f59e0b; }
        body { font-family: 'Montserrat', sans-serif; background: var(--bg-deep); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }
        
        .sidebar { width: 250px; background: var(--glass); border-right: 1px solid var(--glass-border); padding: 20px; display: flex; flex-direction: column; }
        .nav-btn { padding: 12px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: var(--text); opacity: 0.7; border:none; background:none; text-align:left; width:100%; display:flex; gap:10px; align-items:center; }
        .nav-btn:hover, .nav-btn.active { background: rgba(139, 92, 246, 0.1); color: var(--primary); opacity: 1; font-weight: 600; }
        
        .content { flex: 1; padding: 40px; overflow-y: auto; }
        
        .glass-panel { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 16px; padding: 30px; margin-bottom: 20px; }
        button.primary { background: var(--primary); color: white; padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; transition:0.2s }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px 10px; border-bottom: 1px solid var(--glass-border); color: var(--primary); font-size: 0.85rem; }
        td { padding: 15px 10px; border-bottom: 1px solid var(--glass-border); color: var(--text); font-size: 0.95rem; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: var(--glass); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border); }
        .kpi-val { font-size: 1.5rem; font-weight: 700; color: var(--primary); margin-top:5px; }
        .kpi-label { font-size: 0.85rem; opacity: 0.7; }
        
        .badge-desc { background: rgba(245, 158, 11, 0.2); color: var(--warning); padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; border: 1px solid var(--warning); }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2 style="color:var(--primary); margin-bottom:30px">REPORTES</h2>
        
        <button class="nav-btn" onclick="window.location.href='admin.html'"><span class="material-icons-round">arrow_back</span> Volver al Dashboard</button>
        <button class="nav-btn active"><span class="material-icons-round">analytics</span> Estad√≠sticas</button>
        
        <div style="flex:1"></div>
        <button class="nav-btn" onclick="logout()" style="color:var(--danger)">Salir</button>
    </div>

    <div class="content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
            <h1>Reportes y Estad√≠sticas</h1>
            <button class="primary" onclick="descargarExcel()" style="width:auto; background:#10b981">üì• Descargar Historial Ventas</button>
        </div>
        
        <div class="kpi-grid">
            <div class="kpi-card"><div class="kpi-label">Ventas Hoy</div><div id="kpi-ventas-hoy" class="kpi-val">$0</div></div>
            <div class="kpi-card"><div class="kpi-label">Efectivo Caja</div><div id="kpi-caja" class="kpi-val" style="color:var(--success)">$0</div></div>
            <div class="kpi-card"><div class="kpi-label">Propinas</div><div id="kpi-propinas" class="kpi-val" style="color:var(--warning)">$0</div></div>
            <div class="kpi-card"><div class="kpi-label">Pedidos</div><div id="kpi-pedidos" class="kpi-val">0</div></div>
        </div>

        <div class="glass-panel" style="margin-top:30px">
            <h3>Tendencia de Ventas (7 D√≠as)</h3>
            <canvas id="chart-ventas" style="max-height:300px"></canvas>
        </div>

        <div class="glass-panel" style="margin-top:20px; border:1px solid rgba(139,92,246,0.3)">
            <h3>Estado de Resultados (Global)</h3>
            <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:20px; text-align:center">
                <div><div style="opacity:0.7">Ingresos Totales</div><div id="pnl-ingresos" style="font-size:1.2rem; font-weight:bold">$0</div></div>
                <div><div style="opacity:0.7">Descuentos Totales</div><div id="pnl-descuentos" style="font-size:1.2rem; font-weight:bold; color:var(--warning)">$0</div></div>
                <div><div style="opacity:0.7">Costos (Est)</div><div id="pnl-costos" style="font-size:1.2rem; font-weight:bold; color:var(--danger)">$0</div></div>
                <div><div style="opacity:0.7">Utilidad Neta</div><div id="pnl-utilidad" style="font-size:1.2rem; font-weight:bold; color:var(--success)">$0</div></div>
            </div>
            <div style="text-align:center; margin-top:10px; font-size:0.9rem; opacity:0.6">Margen: <span id="pnl-margen">0%</span></div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr; gap:20px; margin-top:20px">
            <div class="glass-panel">
                <h3>üõí Detalle de Ventas (Hoy)</h3>
                <table>
                    <thead><tr><th>Hora</th><th>Mesa</th><th>Cliente</th><th>Total Final</th><th>Descuento</th><th>Pago</th></tr></thead>
                    <tbody id="tabla-ventas-detalle"></tbody>
                </table>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px">
            <div class="glass-panel"><h3>üèÜ Rendimiento Staff</h3><table id="tabla-staff"></table></div>
            <div class="glass-panel"><h3>üî• Productos Top</h3><table id="tabla-top"></table></div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        checkAuth();
        let datosVentasExcel = [];

        // Inicializamos cargando todo
        cargarListaVentas();
        cargarPnL();
        cargarKPIs();
        cargarGraficos();

        async function cargarListaVentas() {
            try {
                const resVentas = await apiFetch('/ventas/?limit=200');
                const todasVentas = resVentas ? resVentas.data : [];
                const hoyStr = new Date().toDateString();
                const ventasHoy = todasVentas.filter(v => new Date(v.fecha).toDateString() === hoyStr);
                const limite7dias = new Date(); limite7dias.setDate(limite7dias.getDate() - 7);
                const ventas7dias = todasVentas.filter(v => new Date(v.fecha) >= limite7dias);
                
                datosVentasExcel = ventas7dias.map(v => ({ Fecha: new Date(v.fecha).toLocaleString(), Mesa: v.mesa, Cliente: v.cliente_nombre || 'General', Total: v.total_final, Descuento: v.descuento_porcentaje + '%', MetodoPago: v.metodo_pago }));

                document.getElementById('tabla-ventas-detalle').innerHTML = ventasHoy.map(v => {
                    const hora = new Date(v.fecha).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    const descBadge = v.descuento_porcentaje > 0 ? `<span class="badge-desc">-${v.descuento_porcentaje}%</span>` : '<span style="opacity:0.3">-</span>';
                    return `<tr><td>${hora}</td><td><b>${v.mesa}</b></td><td>${v.cliente_nombre || 'Consumidor Final'}</td><td>$${v.total_final.toLocaleString()}</td><td>${descBadge}</td><td><small>${v.metodo_pago || '?'}</small></td></tr>`;
                }).join('');
            } catch(e){ console.error("Fallo Cargar Ventas", e); }
        }

        async function cargarPnL() {
            try {
                const rAdv = await apiFetch('/ventas/reporte/avanzado');
                if(rAdv){
                    document.getElementById('pnl-ingresos').innerText = `$${rAdv.pnl.ingresos_brutos.toLocaleString()}`;
                    document.getElementById('pnl-descuentos').innerText = `-$${rAdv.pnl.descuentos_dados.toLocaleString()}`;
                    document.getElementById('pnl-costos').innerText = `-$${rAdv.pnl.costos_insumos.toLocaleString()}`;
                    document.getElementById('pnl-utilidad').innerText = `$${rAdv.pnl.utilidad_bruta.toLocaleString()}`;
                    document.getElementById('pnl-margen').innerText = `${rAdv.pnl.margen_porcentaje}%`;
                    document.getElementById('tabla-staff').innerHTML = `<tr><th>Nombre</th><th>#</th><th>$</th></tr>` + rAdv.trabajadores.map(t=>`<tr><td>${t.nombre}</td><td>${t.pedidos}</td><td>$${t.dinero.toLocaleString()}</td></tr>`).join('');
                    document.getElementById('tabla-top').innerHTML = `<tr><th>Producto</th><th>Cant</th></tr>` + rAdv.top_productos.map(p=>`<tr><td>${p.nombre}</td><td>${p.cantidad}</td></tr>`).join('');
                }
            } catch(e){ console.error("Fallo PnL", e); }
        }

        async function cargarKPIs() {
            try {
                const rBasico = await apiFetch('/ventas/reporte/resumen');
                if(rBasico) {
                    document.getElementById('kpi-ventas-hoy').innerText = `$${rBasico.ventas_netas.toLocaleString()}`;
                    document.getElementById('kpi-caja').innerText = `$${rBasico.total_caja.toLocaleString()}`;
                    document.getElementById('kpi-propinas').innerText = `$${rBasico.propinas.toLocaleString()}`;
                    document.getElementById('kpi-pedidos').innerText = rBasico.pedidos_hoy;
                }
            } catch(e){ console.error("Fallo KPIs", e); }
        }

        async function cargarGraficos() {
            try {
                const gData = await apiFetch('/ventas/reporte/graficos');
                if(gData && gData.grafico_ventas){
                    const ctx = document.getElementById('chart-ventas').getContext('2d');
                    if(window.myChart) window.myChart.destroy();
                    window.myChart = new Chart(ctx, { type: 'line', data: { labels: gData.grafico_ventas.categorias, datasets: [{ label: 'Ventas ($)', data: gData.grafico_ventas.data, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.2)', tension: 0.4, fill: true }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { grid: { display: false } } } } });
                }
            } catch(e){ console.error("Fallo Graficos", e); }
        }

        function descargarExcel(){
            if(datosVentasExcel.length === 0) return alert("No hay historial reciente para descargar");
            const ws = XLSX.utils.json_to_sheet(datosVentasExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Historial_Ventas");
            XLSX.writeFile(wb, "Reporte_Ventas_7Dias.xlsx");
        }

        function logout(){localStorage.clear();window.location.href='login.html';}
    </script>
</body>
</html>