<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala - GastroPOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root { --bg: #f9fafb; --card: #ffffff; --brand: #465fff; --success: #12b76a; --warning: #f79009; --error: #f04438; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 250px; background: #101828; color: white; padding: 20px; display: flex; flex-direction: column; }
        .content { flex: 1; padding: 30px; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .card { background: var(--card); height: 160px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 2px solid transparent; transition: .3s; position: relative; }
        .card:hover { transform: translateY(-3px); }
        .libre { border-color: #e2e8f0; } 
        .pendiente { background: #fef2f2; border-color: var(--error); }
        .listo { background: #ecfdf5; border-color: var(--success); animation: pulse 2s infinite; }
        .entregado { background: #eff8ff; border-color: var(--brand); }
        .por_cobrar { background: #fffbeb; border-color: var(--warning); }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(18, 183, 106, 0.4);} 70% {box-shadow: 0 0 0 10px rgba(18, 183, 106, 0);} 100% {box-shadow: 0 0 0 0 rgba(18, 183, 106, 0);} }
        .pill { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; }
        .libre .pill { background: #f1f5f9; color: #64748b; }
        .pendiente .pill { background: #fee2e2; color: var(--error); }
        .listo .pill { background: #d1fae5; color: var(--success); }
        .entregado .pill { background: #dbeafe; color: var(--brand); }
        .por_cobrar .pill { background: #fef3c7; color: var(--warning); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y:auto; }
        button { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-primary { background: var(--brand); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-outline { background: transparent; border: 1px solid #ccc; color: #333; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 14px; }
        
        /* Estilos Split */
        .split-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #eee; }
        .split-row input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>üçΩÔ∏è GastroPOS</h2>
        <div style="margin-top:auto">
            <p id="user-display" style="color:#94a3b8; font-size:14px">Mesero</p>
            <button onclick="logout()" style="background:#334155; color:white">Salir</button>
        </div>
    </div>

    <div class="content">
        <h1>Sala Principal</h1>
        <div id="grid" class="grid">Cargando mesas...</div>
    </div>

    <div id="modal-order" class="modal">
        <div class="modal-box">
            <h2 id="modal-title">Nueva Orden</h2>
            <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <label style="font-size:12px; font-weight:bold; color:#64748b">AGREGAR PRODUCTO</label>
                <div style="display:flex; gap:10px; margin-top:5px">
                    <select id="sel-prod" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:6px"></select>
                    <input type="number" id="inp-cant" value="1" min="1" style="width:60px; padding:10px; border:1px solid #ccc; border-radius:6px">
                </div>
                <button class="btn-outline" onclick="agregarAlCarrito()" style="margin-top:10px; font-size:13px">
                    <span class="material-icons-round" style="font-size:16px; vertical-align:middle">add</span> Agregar a la lista
                </button>
            </div>
            <div id="cart-list" style="min-height: 50px; margin-bottom: 15px;"></div>
            <button class="btn-primary" onclick="enviarPedido()">ENVIAR A COCINA</button>
            <button onclick="closeModal('modal-order')" style="background:transparent; color:#666">Cancelar</button>
        </div>
    </div>

    <div id="modal-actions" class="modal">
        <div class="modal-box">
            <h2 id="act-title">Mesa</h2>
            <p id="act-info" style="font-size:14px; color:#64748b; margin-bottom:20px"></p>
            <div id="act-buttons"></div>
            
            <div id="div-cuenta" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:15px">
                <p style="font-weight:bold; margin-bottom:10px">Opciones de Cuenta:</p>
                <div style="display:flex; gap:10px">
                    <button class="btn-primary" onclick="pedirCuenta('unica')">Cuenta √önica</button>
                    <button class="btn-warning" onclick="prepararDivision()">Cuentas Separadas</button>
                </div>
            </div>
            <button onclick="closeModal('modal-actions')" style="background:transparent; color:#666; margin-top:15px">Cerrar</button>
        </div>
    </div>

    <div id="modal-split" class="modal">
        <div class="modal-box">
            <h2>Dividir Cuenta</h2>
            <p style="font-size:13px; color:#666; margin-bottom:15px">Asigna el nombre de quien paga cada producto.</p>
            <div id="split-list" style="max-height:300px; overflow-y:auto; margin-bottom:20px"></div>
            <button class="btn-success" onclick="confirmarDivision()">‚úÖ Enviar a Caja Separado</button>
            <button onclick="closeModal('modal-split')" style="background:transparent; color:#666">Cancelar</button>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        checkAuth();
        let MESAS = [], productos = [], ventasActivas = [], carrito = [];
        let mesaSeleccionada = null, ventaActual = null;

        document.getElementById('user-display').innerText = localStorage.getItem('user_name') || 'Usuario';

        async function init() {
            await cargarProductos();
            await cargarMesasReales();
            await cargarVentas();
            renderMesas();
        }

        async function cargarMesasReales() {
            const res = await apiFetch('/mesas/');
            if(res && res.data) MESAS = res.data.map(m => m.nombre);
        }

        async function cargarProductos() {
            const res = await apiFetch('/productos/');
            if(res) {
                productos = res.data || res;
                document.getElementById('sel-prod').innerHTML = productos.map(p => `<option value="${p.id}">${p.nombre} - $${p.precio}</option>`).join('');
            }
        }

        async function cargarVentas() {
            const res = await apiFetch('/ventas/');
            if(res) ventasActivas = (res.data || res).filter(v => v.estado !== 'pagado' && v.estado !== 'cerrado_split');
        }

        function renderMesas() {
            const grid = document.getElementById('grid');
            if(MESAS.length > 0) grid.innerHTML = '';
            MESAS.forEach(mesaNombre => {
                const venta = ventasActivas.find(v => v.mesa === mesaNombre);
                let estado='libre', texto='LIBRE', icono='table_restaurant';
                if (venta) {
                    if (venta.estado === 'pendiente') { estado='pendiente'; texto='COCINANDO'; icono='soup_kitchen'; }
                    else if (venta.estado === 'listo') { estado='listo'; texto='¬°LISTO!'; icono='room_service'; }
                    else if (venta.estado === 'entregado') { estado='entregado'; texto='COMIENDO'; icono='restaurant'; }
                    else if (venta.estado === 'por_cobrar') { estado='por_cobrar'; texto='COBRAR'; icono='attach_money'; }
                }
                const card = document.createElement('div');
                card.className = `card ${estado}`;
                card.onclick = () => clickMesa(mesaNombre, venta);
                card.innerHTML = `
                    <span class="pill">${texto}</span>
                    <span class="material-icons-round" style="font-size:40px; color:${estado==='libre'?'#94a3b8':'inherit'}">${icono}</span>
                    <h3>${mesaNombre}</h3>
                    ${venta ? `<small>$${venta.total}</small>` : ''}
                `;
                grid.appendChild(card);
            });
        }

        function clickMesa(nombre, venta) {
            mesaSeleccionada = nombre;
            ventaActual = venta;
            
            if (!venta) {
                abrirModalPedido(nombre);
            } else {
                document.getElementById('act-title').innerText = nombre;
                const itemsTxt = venta.detalles.map(d => `${d.cantidad} ${d.producto_nombre}`).join(', ');
                document.getElementById('act-info').innerHTML = `<b>Total:</b> $${venta.total}<br><div style="font-size:12px;color:#666">${itemsTxt}</div>`;
                
                const btnDiv = document.getElementById('act-buttons');
                const divCuenta = document.getElementById('div-cuenta');
                btnDiv.innerHTML = '';
                divCuenta.style.display = 'none';

                if (venta.estado === 'pendiente') {
                    btnDiv.innerHTML = `<p style="color:#f04438;text-align:center">‚è≥ Cocinando...</p><button class="btn-outline" onclick="abrirModalPedido('${nombre}')">‚ûï Agregar m√°s</button>`;
                } else if (venta.estado === 'listo') {
                    btnDiv.innerHTML = `<button class="btn-success" onclick="accionMesa('entregar_mesa')">‚úÖ Servir Mesa</button>`;
                } else if (venta.estado === 'entregado') {
                    btnDiv.innerHTML = `<button class="btn-primary" onclick="abrirModalPedido('${nombre}')">‚ûï Agregar m√°s</button><button class="btn-warning" onclick="document.getElementById('div-cuenta').style.display='block'">üìÑ Pedir la Cuenta</button>`;
                } else if (venta.estado === 'por_cobrar') {
                    btnDiv.innerHTML = `<p style="color:#f59e0b;text-align:center">üí∏ Esperando a Caja (${venta.tipo_cuenta})</p>`;
                }
                document.getElementById('modal-actions').style.display = 'flex';
            }
        }

        // --- CARRITO ---
        function abrirModalPedido(nombre) {
            closeModal('modal-actions');
            mesaSeleccionada = nombre;
            carrito = [];
            renderCarrito();
            document.getElementById('modal-title').innerText = `Pedido ${nombre}`;
            document.getElementById('modal-order').style.display = 'flex';
        }
        function agregarAlCarrito() {
            const prodId = document.getElementById('sel-prod').value;
            const cant = parseInt(document.getElementById('inp-cant').value);
            const prod = productos.find(p => p.id === prodId);
            if (cant > 0) {
                carrito.push({ producto_id: prodId, nombre: prod.nombre, cantidad: cant });
                renderCarrito();
            }
        }
        function renderCarrito() {
            const div = document.getElementById('cart-list');
            div.innerHTML = carrito.length ? '' : '<p style="text-align:center;color:#999">Lista vac√≠a</p>';
            carrito.forEach((it, i) => div.innerHTML += `<div class="cart-item"><span>${it.cantidad}x ${it.nombre}</span><span onclick="carrito.splice(${i},1);renderCarrito()" style="color:red;cursor:pointer">x</span></div>`);
        }
        async function enviarPedido() {
            if(!carrito.length) return;
            const res = await apiFetch('/ventas/', 'POST', { mesa: mesaSeleccionada, detalles: carrito });
            if(res) { closeModal('modal-order'); init(); }
        }

        // --- LOGICA DE DIVISION DE CUENTA (NUEVO) ---
        function prepararDivision() {
            closeModal('modal-actions');
            const list = document.getElementById('split-list');
            list.innerHTML = '';
            
            // Generamos una fila por cada producto para ponerle nombre
            ventaActual.detalles.forEach(d => {
                // Si hay cantidad > 1, idealmente se dividir√≠a, pero para simplificar v1
                // asumimos que el bloque completo va a una persona o el mesero separ√≥ en el pedido.
                // Aqu√≠ mostramos "2x Coca Cola" y un input para el nombre.
                list.innerHTML += `
                    <div class="split-row">
                        <div style="width:150px; font-size:14px"><b>${d.cantidad}x</b> ${d.producto_nombre}</div>
                        <input type="text" id="split-name-${d.id}" placeholder="Nombre comensal (Ej: Juan)" value="${d.comensal !== 'Mesa' ? d.comensal : ''}">
                    </div>
                `;
            });
            document.getElementById('modal-split').style.display = 'flex';
        }

        async function confirmarDivision() {
            const asignaciones = [];
            ventaActual.detalles.forEach(d => {
                const nombre = document.getElementById(`split-name-${d.id}`).value.trim() || "Mesa";
                asignaciones.push({ detalle_id: d.id, comensal: nombre });
            });

            const res = await apiFetch(`/ventas/${ventaActual.id}/dividir_por_nombres`, 'POST', { asignaciones });
            if(res) {
                alert("‚úÖ Cuenta enviada a caja separada por nombres.");
                closeModal('modal-split');
                init();
            }
        }

        async function pedirCuenta(tipo) {
            if(!confirm("¬øPedir cuenta total?")) return;
            const res = await apiFetch(`/ventas/${ventaActual.id}/solicitar_cuenta?tipo=${tipo}`, 'POST', {});
            if(res) { closeModal('modal-actions'); init(); }
        }

        async function accionMesa(act) {
            await apiFetch(`/ventas/${ventaActual.id}/${act}`, 'POST', {});
            closeModal('modal-actions'); init();
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function logout() { localStorage.clear(); window.location.href='login.html'; }
        setInterval(init, 5000);
        init();
    </script>
</body>
</html>