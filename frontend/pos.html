<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala - GastroPOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root { 
            --bg-deep: #121212; 
            --text-main: #ffffff; 
            --neon-primary: #ff7e5f; 
            --input-bg: rgba(0,0,0,0.5); 
            --glass-border: rgba(255,255,255,0.1); 
            --sidebar-bg: rgba(20,20,20,0.95);
        }

        /* MODO CLARO */
        body.light-mode {
            --bg-deep: #f0fdf4; 
            --text-main: #1f2937;
            --input-bg: #ffffff;
            --glass-border: #e5e7eb;
            --sidebar-bg: #ffffff;
        }
        body.light-mode .mesa-node {
            background: #ffffff;
            border: 2px solid #e5e7eb;
            color: #1f2937;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        body.light-mode .prod-item:hover {
            background: #e5e7eb;
            filter: none;
        }
        body.light-mode input {
            background: #ffffff;
            border: 1px solid #d1d5db;
            color: #1f2937;
        }

        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-deep); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }
        
        .sidebar { width: 80px; background: var(--sidebar-bg); display: flex; flex-direction: column; align-items: center; padding: 20px 0; border-right: 1px solid var(--glass-border); transition: 0.3s; }
        .nav-btn { background: none; border: none; color: #aaa; font-size: 1.5rem; margin-bottom: 20px; cursor: pointer; padding: 10px; border-radius: 10px; transition: 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); color: var(--neon-primary); }

        .content { flex: 1; padding: 20px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }

        .mesa-node { aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #444; position: relative; transition: 0.2s; }
        .mesa-node:hover { transform: scale(1.05); }
        .mesa-badge { font-size: 0.75rem; font-weight: bold; padding: 2px 8px; border-radius: 10px; margin-top: 5px; }

        /* COLORES CATEGOR√çAS */
        .cat-bebidas { border-left: 4px solid #06b6d4 !important; background: rgba(6, 182, 212, 0.05); }
        .cat-fuertes { border-left: 4px solid #f97316 !important; background: rgba(249, 115, 22, 0.05); }
        .cat-livianos { border-left: 4px solid #84cc16 !important; background: rgba(132, 204, 22, 0.05); }
        .cat-entradas { border-left: 4px solid #eab308 !important; background: rgba(234, 179, 8, 0.05); }
        .cat-postres { border-left: 4px solid #d946ef !important; background: rgba(217, 70, 239, 0.05); }

        .prod-item { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .prod-item:hover { filter: brightness(1.2); background: rgba(255,255,255,0.05); }
        .prod-item.selected { background: var(--neon-primary); color: black; font-weight: bold; }
        
        details { padding: 0 12px 10px 12px; font-size: 0.8rem; color: #aaa; }
        summary { cursor: pointer; outline: none; list-style: none; color: var(--neon-primary); font-size: 0.75rem; margin-top: 5px; }

        /* MODALES */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 999; backdrop-filter: blur(5px); }
        .modal-box { background: #1a1a1a; padding: 25px; border-radius: 20px; width: 500px; max-width:90%; max-height:85vh; overflow-y:auto; border: 1px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        body.light-mode .modal-box { background: #ffffff; color: #1f2937; border: 1px solid #ccc; }
        
        input, select { background: #333; border: 1px solid #555; color: white; padding: 12px; width: 100%; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; outline: none; }
        button { padding: 12px; border-radius: 8px; cursor: pointer; border: none; font-weight: bold; width: 100%; margin-top: 10px; font-size: 1rem; transition: 0.2s; }
        .btn-neon { background: var(--neon-primary); color: white; }
        .btn-ghost { background: transparent; border: 1px solid #555; color: #ccc; }
        
        .split-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px dashed #444; padding-bottom: 5px; }
    </style>
</head>
<body>
    <div class="sidebar">
        <span class="material-icons-round" style="font-size:32px; color:var(--neon-primary); margin-bottom:40px">restaurant</span>
        
        <button class="nav-btn" onclick="toggleTheme()"><span class="material-icons-round" id="theme-icon">light_mode</span></button>
        
        <button class="nav-btn" onclick="location.reload()"><span class="material-icons-round">refresh</span></button>
        <div style="flex:1"></div>
        <button class="nav-btn" onclick="logout()" style="color:#ef4444"><span class="material-icons-round">logout</span></button>
    </div>

    <div class="content">
        <div class="header">
            <h1 style="margin:0">Sala Principal</h1>
            <div id="reloj" style="font-weight:bold; opacity:0.7">--:--</div>
        </div>
        <div id="grid" class="grid"></div>
    </div>

    <div id="modal-order" class="modal">
        <div class="modal-box">
            <h2 style="margin-top:0">Pedido <span id="lbl-mesa" style="color:var(--neon-primary)"></span></h2>
            <input id="prod-search" placeholder="üîç Buscar producto..." onkeyup="filterProd()">
            <div id="prod-list" style="height:250px; overflow-y:auto; border:1px solid #333; margin-bottom:15px; border-radius:8px"></div>
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px">
                <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px">
                    <span id="lbl-sel" style="flex:1; font-weight:bold; color:var(--neon-primary)">Selecciona un producto</span>
                    <input type="number" id="cant" value="1" min="1" style="width:70px; text-align:center; font-weight:bold; margin:0">
                </div>
                <input id="notas" placeholder="üìù Notas (Sin cebolla...)" style="margin:0">
                <button class="btn-ghost" onclick="addCart()" style="border-color:var(--neon-primary); color:var(--neon-primary); margin-top:10px">+ A√ëADIR</button>
            </div>
            <div id="cart-list" style="margin-top:15px; max-height:120px; overflow-y:auto; font-size:0.9rem; color:#ccc; border-top:1px dashed #444; padding-top:10px"></div>
            <div style="display:flex; gap:10px; margin-top:15px">
                <button onclick="sendOrder()" style="background:#10b981; color:white; flex:2">ENVIAR A COCINA</button>
                <button onclick="closeModal('modal-order')" class="btn-ghost" style="flex:1">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-actions" class="modal">
        <div class="modal-box" style="text-align:center">
            <h2 id="act-title" style="margin-top:0">Mesa Ocupada</h2>
            <div id="act-info" style="margin-bottom:20px; font-size:1.2rem; font-weight:bold; color:#aaa"></div>
            <div id="act-items" style="text-align:left; max-height:150px; overflow-y:auto; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px; margin-bottom:20px; font-size:0.9rem"></div>

            <div id="btn-servir-container" style="display:none; margin-bottom:15px">
                <button onclick="accionMesa('entregar_mesa')" style="background:#10b981; color:white">üçΩÔ∏è SERVIR TODO</button>
            </div>

            <button onclick="abrirModalPedido(mesaSeleccionada)" class="btn-ghost" style="color:#3b82f6; border-color:#3b82f6; margin-bottom:15px">+ AGREGAR PRODUCTOS</button>

            <div style="display:flex; gap:10px; border-top:1px solid #444; padding-top:15px">
                <button onclick="pedirCuenta('unica')" class="btn-ghost" style="border-color:#10b981; color:#10b981; flex:1">üí∞ √öNICA</button>
                <button onclick="prepararDivision()" class="btn-ghost" style="border-color:#f59e0b; color:#f59e0b; flex:1">üë• SEPARADA</button>
            </div>
            
            <button onclick="closeModal('modal-actions')" class="btn-ghost" style="margin-top:20px; border:none">Cerrar</button>
        </div>
    </div>

    <div id="modal-split" class="modal">
        <div class="modal-box">
            <h2>Dividir Cuenta</h2>
            <p style="font-size:0.8rem; color:#aaa">Asigna un nombre a cada item</p>
            <div id="split-list" style="max-height:300px; overflow-y:auto; margin-bottom:15px; text-align:left"></div>
            <button onclick="confirmarDivision()" style="background:#f59e0b; color:black">CONFIRMAR DIVISI√ìN</button>
            <button onclick="closeModal('modal-split')" class="btn-ghost">Cancelar</button>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        checkAuth();
        // Inicializar tema si api.js no lo ha hecho a√∫n
        if(window.initTheme) initTheme();

        let MESAS=[], allProds=[], cart=[], selId=null, mesaSeleccionada=null, ventaActual=null;

        setInterval(() => document.getElementById('reloj').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 1000);

        // --- CORRECCI√ìN AQU√ç ---
        // 1. Cargar productos SOLO UNA VEZ al principio
        async function cargarDatosIniciales(){
            try {
                // Cargar Productos (Men√∫ est√°tico)
                const rp = await apiFetch('/productos/'); 
                if(rp){ allProds=rp.data; renderList(allProds); }
                
                // Cargar Mesas iniciales
                const rm = await apiFetch('/mesas/'); 
                if(rm) MESAS=rm.data.map(m=>m.nombre);

                // Arrancar el bucle de actualizaci√≥n de ESTADO
                actualizarEstado(); // Ejecutar primera vez
                setInterval(actualizarEstado, 5000); // Repetir cada 5s
            } catch(e) { console.error(e); }
        }

        // 2. Funci√≥n que se repite (SOLO actualiza colores y estados, NO recarga productos)
        async function actualizarEstado(){
            try {
                // Volvemos a pedir mesas por si agregaron una nueva en admin
                const rm = await apiFetch('/mesas/'); 
                if(rm) MESAS=rm.data.map(m=>m.nombre);
                
                // Renderizar SOLO la grilla de mesas (colores)
                renderMesas();
            } catch(e){ console.error("Error actualizando estado", e); }
        }

        function renderList(list){
            document.getElementById('prod-list').innerHTML = list.map(p => {
                let catClass = 'cat-general';
                if(p.categoria === 'Bebidas') catClass = 'cat-bebidas';
                if(p.categoria === 'Fuertes') catClass = 'cat-fuertes';
                if(p.categoria === 'Livianos') catClass = 'cat-livianos';
                if(p.categoria === 'Entradas') catClass = 'cat-entradas';
                if(p.categoria === 'Postres') catClass = 'cat-postres';
                
                const ingStr = p.recetas.map(r => `${r.insumo_nombre}`).join(', ');
                const tieneIng = p.recetas.length > 0;

                return `
                <div style="border-bottom:1px solid #333">
                    <div class="prod-item ${catClass} ${selId===p.id?'selected':''}" onclick="sel('${p.id}','${p.nombre}')">
                        <span>${p.nombre}</span><span style="font-weight:bold">$${p.precio.toLocaleString()}</span>
                    </div>
                    ${tieneIng ? `<details><summary>Ingredientes</summary>${ingStr}</details>` : ''}
                </div>`;
            }).join('');
        }

        function filterProd(){ const t = document.getElementById('prod-search').value.toLowerCase(); renderList(allProds.filter(p=>p.nombre.toLowerCase().includes(t))); }
        function sel(id, nom){ selId=id; document.getElementById('lbl-sel').innerText=nom; renderList(allProds); }

        async function renderMesas(){
            const rv=await apiFetch('/ventas/'); 
            // Filtrar ventas activas
            const act=(rv.data||rv).filter(v=>v.estado!=='pagado'&&v.estado!=='cerrado_split');
            
            document.getElementById('grid').innerHTML=MESAS.map(m=>{
                const v=act.find(x=>x.mesa===m);
                let color='#10b981', estado='LIBRE';
                if(v){
                    if(v.estado==='pendiente'){ color='#ef4444'; estado='COCINANDO'; } 
                    else if(v.estado==='listo'){ color='#f97316'; estado='SERVIR'; } 
                    else if(v.estado==='entregado'){ color='#3b82f6'; estado='OCUPADA'; } 
                    else if(v.estado==='por_cobrar'){ color='#a855f7'; estado='PAGANDO'; } 
                }
                const ventaString = v ? encodeURIComponent(JSON.stringify(v)) : 'null';
                return `<div class="mesa-node" onclick="clickMesa('${m}', '${ventaString}')" style="border-color:${color}; box-shadow: 0 0 15px ${v?color:'transparent'}">
                    <b style="font-size:1.2rem">${m}</b>
                    <div class="mesa-badge" style="background:${color}; color:${v?'white':'#000'}">${estado}</div>
                    ${v ? `<small style="margin-top:5px">$${v.total.toLocaleString()}</small>` : ''}
                </div>`
            }).join('');
        }

        function clickMesa(nombreMesa, ventaEncoded){
            mesaSeleccionada = nombreMesa;
            ventaActual = ventaEncoded !== 'null' ? JSON.parse(decodeURIComponent(ventaEncoded)) : null;

            if(!ventaActual){
                abrirModalPedido(nombreMesa);
            } else {
                document.getElementById('act-title').innerText = `Mesa ${nombreMesa}`;
                document.getElementById('act-info').innerText = `Total: $${ventaActual.total.toLocaleString()}`;
                document.getElementById('act-items').innerHTML = ventaActual.detalles.map(d => `<div>${d.cantidad}x ${d.producto_nombre}</div>`).join('');
                document.getElementById('btn-servir-container').style.display = (ventaActual.estado === 'listo') ? 'block' : 'none';
                document.getElementById('modal-actions').style.display = 'flex';
            }
        }

        function abrirModalPedido(nom){
            closeModal('modal-actions');
            mesaSeleccionada = nom;
            document.getElementById('lbl-mesa').innerText = nom;
            cart=[]; renderCart();
            document.getElementById('prod-search').value = '';
            selId = null; document.getElementById('lbl-sel').innerText = "Selecciona un producto";
            
            // Al abrir, mostramos todos, pero NO recargamos del servidor
            renderList(allProds); 
            document.getElementById('modal-order').style.display = 'flex';
        }

        function addCart(){
            if(!selId) return alert("Selecciona un producto");
            const p = allProds.find(x=>x.id===selId);
            cart.push({producto_id:p.id, nombre:p.nombre, cantidad:parseInt(document.getElementById('cant').value), notas:document.getElementById('notas').value});
            renderCart();
            document.getElementById('notas').value=''; document.getElementById('cant').value=1;
        }
        function renderCart(){ document.getElementById('cart-list').innerHTML=cart.map((c,i)=>`<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #333"><span><b>${c.cantidad}x</b> ${c.nombre} <small style="color:var(--neon-primary)">${c.notas}</small></span><span style="color:#ef4444; cursor:pointer" onclick="cart.splice(${i},1);renderCart()">‚úï</span></div>`).join(''); }
        
        async function sendOrder(){
            if(cart.length===0) return alert("Carrito vac√≠o");
            await apiFetch('/ventas/','POST',{mesa:mesaSeleccionada, detalles:cart});
            closeModal('modal-order'); actualizarEstado(); 
        }

        async function accionMesa(accion){
            if(!ventaActual) return;
            await apiFetch(`/ventas/${ventaActual.id}/${accion}`, 'POST', {});
            closeModal('modal-actions'); actualizarEstado();
        }

        async function pedirCuenta(tipo){
            if(!ventaActual) return;
            if(confirm(`¬øPedir cuenta ${tipo.toUpperCase()}?`)) {
                await apiFetch(`/ventas/${ventaActual.id}/solicitar_cuenta?tipo=${tipo}`, 'POST', {});
                closeModal('modal-actions'); actualizarEstado();
            }
        }

        function prepararDivision(){
            if(!ventaActual) return;
            closeModal('modal-actions');
            const div = document.getElementById('split-list');
            div.innerHTML = '';
            ventaActual.detalles.forEach(d => {
                const valorActual = d.comensal && d.comensal !== 'Mesa' ? d.comensal : '';
                div.innerHTML += `
                <div class="split-item">
                    <span><b>${d.cantidad}x</b> ${d.producto_nombre}</span>
                    <input type="text" id="split-${d.id}" value="${valorActual}" placeholder="Nombre Persona" style="width:150px; padding:8px; margin:0">
                </div>`;
            });
            document.getElementById('modal-split').style.display = 'flex';
        }

        async function confirmarDivision(){
            const asignaciones = ventaActual.detalles.map(d => ({
                detalle_id: d.id,
                comensal: document.getElementById(`split-${d.id}`).value.trim() || "Mesa"
            }));
            await apiFetch(`/ventas/${ventaActual.id}/dividir_por_nombres`, 'POST', {asignaciones});
            closeModal('modal-split');
            actualizarEstado(); 
        }

        function closeModal(id){document.getElementById(id).style.display='none';}
        function logout(){localStorage.removeItem('token'); window.location.href='login.html';}
        
        // INICIO
        cargarDatosIniciales();
    </script>
</body>
</html>