<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin - The Oracle</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { 
            --bg-deep: #09090b; 
            --glass: rgba(255, 255, 255, 0.03); 
            --glass-border: rgba(255, 255, 255, 0.1); 
            --text: #e4e4e7; 
            --primary: #8b5cf6; 
            --input-bg: rgba(0,0,0,0.3); 
            --danger: #ef4444; 
            --success: #10b981; 
            --warning: #f59e0b; 
        }

        /* MODO CLARO */
        body.light-mode {
            --bg-deep: #f3f4f6;
            --glass: #ffffff;
            --glass-border: #d1d5db;
            --text: #1f2937;
            --input-bg: #e5e7eb;
        }
        body.light-mode input, body.light-mode select {
            background: #ffffff;
            border: 1px solid #d1d5db;
            color: #1f2937;
        }
        body.light-mode .sidebar {
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
        }

        body { font-family: 'Montserrat', sans-serif; background: var(--bg-deep); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }
        
        .sidebar { width: 250px; background: var(--glass); border-right: 1px solid var(--glass-border); padding: 20px; display: flex; flex-direction: column; }
        .nav-btn { padding: 12px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: var(--text); opacity: 0.7; border:none; background:none; text-align:left; width:100%; display:flex; gap:10px; align-items:center; }
        .nav-btn:hover, .nav-btn.active { background: rgba(139, 92, 246, 0.1); color: var(--primary); opacity: 1; font-weight: 600; }
        
        .content { flex: 1; padding: 40px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.4s; } .section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        
        .glass-panel { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 16px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        input, select { background: var(--input-bg); border: 1px solid var(--glass-border); color: var(--text); padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 10px; box-sizing:border-box; outline:none; font-family:inherit; }
        button.primary { background: var(--primary); color: white; padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; transition:0.2s }
        .btn-icon { background: none; border: none; cursor: pointer; color: var(--text); opacity: 0.7; padding: 5px; }
        .btn-icon:hover { opacity: 1; color: var(--primary); }
        .btn-icon.danger:hover { color: var(--danger); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px 10px; border-bottom: 1px solid var(--glass-border); color: var(--primary); font-size: 0.85rem; }
        td { padding: 15px 10px; border-bottom: 1px solid var(--glass-border); color: var(--text); font-size: 0.95rem; }

        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 999; backdrop-filter: blur(5px); }
        .modal-box { background: var(--bg-deep); border: 1px solid var(--glass-border); padding: 30px; border-radius: 16px; text-align: center; color: var(--text); min-width: 350px; }
        .ing-item { display: flex; justify-content: space-between; background: rgba(139,92,246,0.1); padding: 8px; border-radius: 6px; margin-bottom: 5px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2 style="color:var(--primary); margin-bottom:30px">ORACLE ADMIN</h2>
        <button class="nav-btn active" onclick="show('insumos')"><span class="material-icons-round">inventory</span> Inventario</button>
        <button class="nav-btn" onclick="show('productos')"><span class="material-icons-round">restaurant_menu</span> Menú</button>
        <button class="nav-btn" onclick="show('usuarios')"><span class="material-icons-round">people</span> RRHH</button>
        <button class="nav-btn" onclick="show('mesas')"><span class="material-icons-round">table_bar</span> Mesas</button>
        <button class="nav-btn" onclick="window.location.href='reportes.html'"><span class="material-icons-round">analytics</span> Reportes</button>
        <div style="flex:1"></div>
        <button class="nav-btn" onclick="logout()" style="color:var(--danger)">Salir</button>
    </div>

    <div class="content">
        <div id="sec-insumos" class="section active">
            <h1>Gestión de Inventario</h1>
            <div class="glass-panel" style="max-width:900px">
                <input id="i-nombre" placeholder="Nombre (Ej: Leche Deslactosada)">
                <div style="display:flex; gap:10px">
                    <input id="i-unidad" placeholder="Unidad (ml, g, und)">
                    <input type="number" id="i-costo" placeholder="Costo Compra">
                    <input type="number" id="i-stock" placeholder="Stock Actual">
                    <input type="number" id="i-max" placeholder="Stock Máximo">
                </div>
                <div style="display:flex; gap:10px">
                    <button class="primary" id="btn-insumo" onclick="guardarInsumo()">GUARDAR INSUMO</button>
                    <button class="primary" id="btn-cancel-insumo" onclick="cancelarEdicionInsumo()" style="background:#666; display:none;">CANCELAR</button>
                </div>
            </div>
            <div class="glass-panel">
                <table>
                    <thead><tr><th>Insumo</th><th>Stock</th><th>Costo</th><th>Acción</th></tr></thead>
                    <tbody id="tabla-insumos"></tbody>
                </table>
            </div>
        </div>
        
        <div id="sec-productos" class="section">
            <h1>Gestión del Menú</h1>
            <div class="glass-panel" style="display:grid; grid-template-columns:1fr 1fr; gap:30px">
                <div>
                    <h3>1. Información del Plato</h3>
                    <input id="p-nombre" placeholder="Nombre del Plato">
                    <input type="number" id="p-precio" placeholder="Precio de Venta">
                    <label style="font-size:0.8rem; opacity:0.7">Categoría Visual (Color):</label>
                    <select id="p-categoria">
                        <option value="General">General (Gris)</option>
                        <option value="Bebidas">Bebidas (Cian)</option>
                        <option value="Fuertes">Platos Fuertes (Naranja)</option>
                        <option value="Livianos">Livianos (Verde)</option>
                        <option value="Entradas">Entradas (Amarillo)</option>
                        <option value="Postres">Postres (Rosa)</option>
                    </select>
                </div>
                <div>
                    <h3>2. Receta (Escandallo)</h3>
                    <div style="display:flex; gap:10px; align-items:center">
                        <select id="receta-select" style="flex:1" onchange="actualizarUnidadLabel()"></select>
                        <div style="position:relative; width:120px">
                            <input type="number" id="receta-cant" placeholder="Cant." style="width:100%; padding-right:45px">
                            <span id="lbl-unidad" style="position:absolute; right:10px; top:12px; font-size:0.75rem; color:var(--primary); font-weight:bold; pointer-events:none">...</span>
                        </div>
                        <button onclick="addIng()" style="width:auto; padding:0 15px; height:46px; margin-top:0">+</button>
                    </div>
                    <div id="lista-temp" style="margin-top:15px; min-height:50px; border:1px dashed var(--glass-border); border-radius:8px; padding:10px">
                        <small style="opacity:0.5; display:block; text-align:center">Ingredientes agregados aparecerán aquí</small>
                    </div>
                </div>
                <div style="grid-column:1/-1; display:flex; gap:10px">
                    <button class="primary" id="btn-prod" onclick="guardarProducto()">GUARDAR PLATO</button>
                    <button class="primary" id="btn-cancel-prod" onclick="cancelarEdicionProducto()" style="background:#666; display:none;">CANCELAR</button>
                </div>
            </div>
            <div class="glass-panel">
                <table>
                    <thead><tr><th>Plato</th><th>Precio</th><th>Acción</th></tr></thead>
                    <tbody id="tabla-productos"></tbody>
                </table>
            </div>
        </div>

        <div id="sec-usuarios" class="section">
            <h1>Recursos Humanos</h1>
            <div class="glass-panel" style="max-width:500px">
                <input id="u-email" placeholder="Email (Usuario)">
                <input type="password" id="u-pass" placeholder="Contraseña">
                <input id="u-name" placeholder="Nombre Completo">
                <div style="display:flex; gap:10px">
                    <select id="u-rol"><option value="mesero">Mesero</option><option value="cocinero">Cocinero</option><option value="cajero">Cajero</option><option value="admin">Admin</option></select>
                    <button class="primary" onclick="crearUsuario()" style="margin-top:0">REGISTRAR</button>
                </div>
            </div>
            <div class="glass-panel"><table><thead><tr><th>Nombre</th><th>Rol</th><th>Turno Activo</th><th>Acción</th></tr></thead><tbody id="tabla-usuarios"></tbody></table></div>
        </div>

        <div id="sec-mesas" class="section">
            <h1>Gestión de Mesas</h1>
            <div class="glass-panel" style="display:flex; gap:10px; max-width:400px"><input id="m-nombre" placeholder="Nombre Mesa"><button class="primary" onclick="crearMesa()" style="width:auto; margin-top:0">CREAR</button></div>
            <div class="glass-panel"><table><thead><tr><th>Mesa</th><th>Acción</th></tr></thead><tbody id="tabla-mesas"></tbody></table></div>
        </div>
    </div>

    <div id="qr-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:var(--primary)">Credencial</h3>
            <div id="qrcode" style="background:white; padding:10px; display:inline-block; border-radius:8px"></div>
            <div id="qr-info" style="margin:10px 0"></div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:15px">
                <button onclick="descargarCredencialPDF()" style="background:#10b981; border:none; padding:10px 20px; border-radius:8px; color:white; cursor:pointer">Descargar PDF</button>
                <button onclick="document.getElementById('qr-modal').style.display='none'" style="background:transparent; border:1px solid var(--glass-border); color:var(--text); padding:10px 20px; border-radius:8px; cursor:pointer">Cerrar</button>
            </div>
        </div>
    </div>
    
    <button onclick="toggleTheme()" style="position:fixed; top:20px; right:20px; z-index:1000; background:var(--glass); border:1px solid var(--glass-border); color:var(--text); padding:10px; border-radius:50%; cursor:pointer; width:45px; height:45px; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
        <span class="material-icons-round" id="theme-icon">light_mode</span>
    </button>

    <script src="js/api.js"></script>
    <script>
        checkAuth();
        let insumos=[], recetaTemp=[], editInsumoId=null, editProductoId=null, currentQRUser={};
        let productosCache = []; // Para buscar datos al editar

        function show(id){
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            const btn = event ? event.currentTarget : null;
            if(btn) btn.classList.add('active');
            const sec = document.getElementById('sec-'+id);
            if(sec) sec.classList.add('active'); 
            if(id==='insumos') cargarInsumos(); 
            if(id==='productos') { cargarInsumos(); cargarProductos(); } 
            if(id==='usuarios') cargarUsuarios();
            if(id==='mesas') cargarMesas();
        }

        // --- INVENTARIO (INSUMOS) ---
        async function cargarInsumos(){
            try {
                const r=await apiFetch('/insumos/'); 
                if(r){ 
                    insumos=r.data; 
                    document.getElementById('tabla-insumos').innerHTML=insumos.map(i=>`
                    <tr>
                        <td><b>${i.nombre}</b></td>
                        <td>${i.stock_actual}/${i.stock_maximo} ${i.unidad_medida}</td>
                        <td>$${i.costo}</td>
                        <td>
                            <button class="btn-icon" onclick="editIng('${i.id}')" title="Editar"><span class="material-icons-round">edit</span></button>
                            <button class="btn-icon danger" onclick="deleteIng('${i.id}')" title="Eliminar"><span class="material-icons-round">delete</span></button>
                        </td>
                    </tr>`).join(''); 
                    const s=document.getElementById('receta-select'); s.innerHTML=insumos.map(i=>`<option value="${i.id}" data-unidad="${i.unidad_medida}">${i.nombre}</option>`).join(''); 
                    actualizarUnidadLabel(); 
                }
            } catch(e){console.error("Error insumos",e);}
        }

        function editIng(id){ 
            const i=insumos.find(x=>x.id===id); 
            editInsumoId=id; 
            document.getElementById('i-nombre').value=i.nombre; 
            document.getElementById('i-unidad').value=i.unidad_medida; 
            document.getElementById('i-costo').value=i.costo; 
            document.getElementById('i-stock').value=i.stock_actual; 
            document.getElementById('i-max').value=i.stock_maximo; 
            
            document.getElementById('btn-insumo').innerText="ACTUALIZAR"; 
            document.getElementById('btn-cancel-insumo').style.display='inline-block';
        }

        function cancelarEdicionInsumo() {
            editInsumoId = null;
            document.getElementById('i-nombre').value=''; 
            document.getElementById('i-unidad').value=''; 
            document.getElementById('i-costo').value=''; 
            document.getElementById('i-stock').value=''; 
            document.getElementById('i-max').value='';
            document.getElementById('btn-insumo').innerText="GUARDAR INSUMO";
            document.getElementById('btn-cancel-insumo').style.display='none';
        }

        async function guardarInsumo(){ 
            const p={nombre:document.getElementById('i-nombre').value, unidad_medida:document.getElementById('i-unidad').value, costo:document.getElementById('i-costo').value, stock_actual:document.getElementById('i-stock').value, stock_maximo:document.getElementById('i-max').value}; 
            let r; 
            if(editInsumoId) r=await apiFetch(`/insumos/${editInsumoId}`,'PUT',p); 
            else r=await apiFetch('/insumos/','POST',p); 
            
            cancelarEdicionInsumo();
            cargarInsumos(); 
        }

        async function deleteIng(id) {
            if(confirm("¿Estás seguro de ELIMINAR este insumo?\nEsto podría afectar recetas existentes.")) {
                await apiFetch(`/insumos/${id}`, 'DELETE');
                cargarInsumos();
            }
        }
        
        // --- PRODUCTOS ---
        function actualizarUnidadLabel(){ const s=document.getElementById('receta-select'); if(s.selectedIndex>-1) document.getElementById('lbl-unidad').innerText=s.options[s.selectedIndex].getAttribute('data-unidad')||'und'; }
        
        function addIng(){ 
            const s=document.getElementById('receta-select'),c=document.getElementById('receta-cant').value; 
            if(!c)return; 
            recetaTemp.push({
                insumo_id:s.value,
                cantidad_requerida:c,
                nombre:s.options[s.selectedIndex].text,
                unidad:s.options[s.selectedIndex].getAttribute('data-unidad')
            }); 
            document.getElementById('receta-cant').value=''; 
            renderReceta(); 
        }
        
        function renderReceta(){ 
            document.getElementById('lista-temp').innerHTML=recetaTemp.map((r,i)=>`<div class="ing-item"><span>${r.nombre} (${r.cantidad_requerida} ${r.unidad})</span><span onclick="recetaTemp.splice(${i},1);renderReceta()" style="cursor:pointer">✕</span></div>`).join(''); 
        }
        
        async function cargarProductos(){ 
            const r=await apiFetch('/productos/'); 
            if(r) {
                productosCache = r.data; // Guardamos para poder editar
                document.getElementById('tabla-productos').innerHTML=r.data.map(p=>`
                <tr>
                    <td>${p.nombre} <small style="color:var(--primary)">(${p.categoria})</small></td>
                    <td>$${p.precio}</td>
                    <td>
                        <button class="btn-icon" onclick="editProd('${p.id}')"><span class="material-icons-round">edit</span></button>
                        <button class="btn-icon danger" onclick="delProd('${p.id}')"><span class="material-icons-round">delete</span></button>
                    </td>
                </tr>`).join(''); 
            }
        }

        function editProd(id) {
            const p = productosCache.find(x => x.id === id);
            if(!p) return;
            
            editProductoId = id;
            document.getElementById('p-nombre').value = p.nombre;
            document.getElementById('p-precio').value = p.precio;
            document.getElementById('p-categoria').value = p.categoria || "General";
            
            // Reconstruir la receta temp
            // La API debe devolver insumo_id en las recetas para que esto funcione
            recetaTemp = p.recetas.map(r => ({
                insumo_id: r.insumo_id, // Asegúrate que el backend devuelva esto
                cantidad_requerida: r.cantidad_requerida,
                nombre: r.insumo_nombre,
                unidad: r.insumo_medida
            }));
            renderReceta();

            document.getElementById('btn-prod').innerText = "ACTUALIZAR PLATO";
            document.getElementById('btn-cancel-prod').style.display = 'inline-block';
        }

        function cancelarEdicionProducto() {
            editProductoId = null;
            document.getElementById('p-nombre').value = '';
            document.getElementById('p-precio').value = '';
            document.getElementById('p-categoria').value = 'General';
            recetaTemp = [];
            renderReceta();
            document.getElementById('btn-prod').innerText = "GUARDAR PLATO";
            document.getElementById('btn-cancel-prod').style.display = 'none';
        }

        async function guardarProducto(){
            const cat = document.getElementById('p-categoria').value;
            const payload = { 
                nombre:document.getElementById('p-nombre').value, 
                precio:document.getElementById('p-precio').value, 
                categoria: cat, 
                ingredientes:recetaTemp 
            };

            if(editProductoId) {
                // Modo Edición
                await apiFetch(`/productos/${editProductoId}`, 'PUT', payload);
            } else {
                // Modo Creación
                await apiFetch('/productos/', 'POST', payload);
            }
            
            cancelarEdicionProducto();
            cargarProductos(); 
        }

        async function delProd(id){ if(confirm("¿Eliminar?")) await apiFetch(`/productos/${id}`,'DELETE'); cargarProductos(); }

        // --- USUARIOS ---
        async function crearUsuario(){ await apiFetch('/users/','POST',{email:document.getElementById('u-email').value,password:document.getElementById('u-pass').value,full_name:document.getElementById('u-name').value,rol:document.getElementById('u-rol').value}); cargarUsuarios(); }
        
        async function cargarUsuarios(){ 
            const r=await apiFetch('/users/'); 
            if(r) {
                document.getElementById('tabla-usuarios').innerHTML = r.data.map(u => {
                    let controlTurno = '', botonBorrar = '';
                    if(u.rol === 'admin') {
                        controlTurno = '<span style="color:#10b981; font-weight:bold; font-size:0.8rem">SIEMPRE ACTIVO</span>';
                        botonBorrar = ''; 
                    } else {
                        controlTurno = `<label class="switch"><input type="checkbox" ${u.en_turno?'checked':''} onchange="toggleTurno('${u.id}')"><span class="slider"></span></label>`;
                        botonBorrar = `<button class="btn-icon danger" onclick="delUser('${u.id}')"><span class="material-icons-round">delete</span></button>`;
                    }
                    return `<tr><td>${u.full_name}</td><td><span style="text-transform:uppercase; font-size:0.8rem">${u.rol}</span></td><td>${controlTurno}</td><td><button class="btn-icon" onclick="verQR('${u.full_name}','${u.email}')"><span class="material-icons-round">qr_code</span></button> ${botonBorrar}</td></tr>`;
                }).join(''); 
            }
        }
        async function toggleTurno(id){ await apiFetch(`/users/${id}/toggle-turno`,'PATCH',{}); }
        async function delUser(id){ if(confirm("¿Eliminar?")) await apiFetch(`/users/${id}`,'DELETE'); cargarUsuarios(); }
        function verQR(n,e){ const q=document.getElementById('qrcode'); q.innerHTML=''; currentQRUser={name:n,email:e}; new QRCode(q,{text:`${window.location.origin}/frontend/login.html?user=${e}`,width:150,height:150}); document.getElementById('qr-info').innerHTML=`<b>${n}</b><br>${e}`; document.getElementById('qr-modal').style.display='flex'; }
        function descargarCredencialPDF(){ const {jsPDF}=window.jspdf; const doc=new jsPDF({orientation:"portrait",unit:"mm",format:[55,85]}); doc.setFillColor(30,41,59); doc.rect(0,0,55,85,"F"); doc.setTextColor(255,255,255); doc.setFontSize(10); doc.text("GASTRO POS",27.5,10,{align:"center"}); const c=document.querySelector('#qrcode canvas'); if(c) doc.addImage(c.toDataURL('image/png'),'PNG',10,20,35,35); doc.text(currentQRUser.name,27.5,65,{align:"center"}); doc.save(`Credencial.pdf`); }
        async function crearMesa(){ await apiFetch('/mesas/','POST',{nombre:document.getElementById('m-nombre').value}); cargarMesas(); }
        async function cargarMesas(){ const r=await apiFetch('/mesas/'); if(r)document.getElementById('tabla-mesas').innerHTML=r.data.map(m=>`<tr><td><b>${m.nombre}</b></td><td><button class="btn-icon danger" onclick="delMesa('${m.id}')"><span class="material-icons-round">delete</span></button></td></tr>`).join(''); }
        async function delMesa(id){ if(confirm("¿Eliminar?")) await apiFetch(`/mesas/${id}`,'DELETE'); cargarMesas(); }

        function logout(){localStorage.clear();window.location.href='login.html';}
        show('insumos'); 
    </script>
</body>
</html>