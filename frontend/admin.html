<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin - The Oracle</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { --bg-deep: #09090b; --glass: rgba(255, 255, 255, 0.03); --glass-border: rgba(255, 255, 255, 0.1); --text: #e4e4e7; --primary: #8b5cf6; --input-bg: rgba(0,0,0,0.3); --danger: #ef4444; }
        body.light-mode { --bg-deep: #f8fafc; --glass: #ffffff; --glass-border: #e2e8f0; --text: #1e293b; --primary: #7c3aed; --input-bg: #f1f5f9; }
        body { font-family: 'Montserrat', sans-serif; background: var(--bg-deep); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; transition: 0.3s; }
        
        .sidebar { width: 250px; background: var(--glass); border-right: 1px solid var(--glass-border); padding: 20px; display: flex; flex-direction: column; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 10px; margin-bottom: 40px; }
        .nav-btn { padding: 12px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: var(--text); opacity: 0.7; border:none; background:none; text-align:left; width:100%; display:flex; gap:10px; align-items:center; transition:0.2s; font-family:inherit; }
        .nav-btn:hover, .nav-btn.active { background: rgba(139, 92, 246, 0.1); color: var(--primary); opacity: 1; font-weight: 600; }
        
        .content { flex: 1; padding: 40px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.4s; } .section.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        
        .glass-panel { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 16px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        h1 { margin-top: 0; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 20px; color: var(--text); }
        input, select { background: var(--input-bg); border: 1px solid var(--glass-border); color: var(--text); padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 10px; box-sizing:border-box; outline:none; font-family:inherit; }
        input:focus, select:focus { border-color: var(--primary); }
        button.primary { background: var(--primary); color: white; padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.3s; font-family:inherit; text-transform:uppercase; letter-spacing:1px; }
        button.primary:hover { filter: brightness(1.1); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 15px 10px; border-bottom: 1px solid var(--glass-border); color: var(--primary); font-size: 0.85rem; text-transform: uppercase; }
        td { padding: 15px 10px; border-bottom: 1px solid var(--glass-border); color: var(--text); font-size: 0.95rem; }
        tr:hover td { background: rgba(139, 92, 246, 0.05); }
        
        /* TOAST */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: var(--glass); border-left: 4px solid #10b981; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); animation: slideIn 0.3s; backdrop-filter: blur(10px); border: 1px solid var(--glass-border); display: flex; align-items: center; gap: 10px; color: var(--text); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 999; backdrop-filter: blur(5px); }
        .modal-box { background: var(--bg-deep); border: 1px solid var(--glass-border); padding: 30px; border-radius: 16px; text-align: center; color: var(--text); min-width: 350px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .theme-float { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; background: var(--glass); border: 1px solid var(--glass-border); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text); box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.3s; }
        .theme-float:hover { transform: scale(1.1); }
        
        .ing-item { display: flex; justify-content: space-between; background: rgba(139,92,246,0.1); padding: 8px; border-radius: 6px; margin-bottom: 5px; font-size: 0.9rem; }
        #qr-hidden { position: absolute; left: -9999px; }
    </style>
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0">Confirmar Acci√≥n</h3>
            <p id="confirm-msg" style="opacity:0.8; margin-bottom:20px">¬øEst√°s seguro?</p>
            <div style="display:flex; gap:10px; justify-content:center">
                <button onclick="closeConfirm()" style="background:transparent; border:1px solid var(--glass-border); color:var(--text)">Cancelar</button>
                <button id="btn-confirm-ok" style="background:var(--primary)">Confirmar</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo"><span class="material-icons-round" style="color:var(--primary)">hub</span> ORACLE ADMIN</div>
        <button class="nav-btn active" onclick="show('insumos')"><span class="material-icons-round">inventory</span> Inventario</button>
        <button class="nav-btn" onclick="show('productos')"><span class="material-icons-round">restaurant_menu</span> Men√∫</button>
        <button class="nav-btn" onclick="show('usuarios')"><span class="material-icons-round">people</span> RRHH</button>
        <button class="nav-btn" onclick="show('mesas')"><span class="material-icons-round">table_bar</span> Mesas</button>
        <div style="flex:1"></div>
        <a href="reportes.html" class="nav-btn" style="text-decoration:none"><span class="material-icons-round">analytics</span> Reportes</a>
        <button class="nav-btn" onclick="logout()" style="color:var(--danger)"><span class="material-icons-round">logout</span> Salir</button>
    </div>

    <div class="content">
        <div id="sec-insumos" class="section active">
            <h1>Gesti√≥n de Inventario</h1>
            <div class="glass-panel" style="max-width:800px">
                <input id="i-nombre" placeholder="Nombre (ej: Esencia de Fresa)">
                <div style="display:flex; gap:10px">
                    <input id="i-unidad" placeholder="Unidad (ej: ml, g)">
                    <input type="number" id="i-costo" placeholder="Costo">
                    <input type="number" id="i-stock" placeholder="Stock (ej: 1000 para 1 Litro)">
                    <input type="number" id="i-max" placeholder="Capacidad M√°x (Para alerta %)">
                </div>
                <button class="primary" id="btn-insumo" onclick="guardarInsumo()">GUARDAR INSUMO</button>
            </div>
            <div class="glass-panel">
                <table><thead><tr><th>Item</th><th>Stock</th><th>Costo</th><th>Acci√≥n</th></tr></thead><tbody id="tabla-insumos"></tbody></table>
            </div>
        </div>
        
        <div id="sec-productos" class="section">
            <h1>Men√∫</h1>
            <div class="glass-panel" style="display:grid; grid-template-columns:1fr 1fr; gap:20px">
                <div>
                    <h3>1. Info del Plato</h3>
                    <input id="p-nombre" placeholder="Nombre (ej: Batido Fresa)">
                    <input type="number" id="p-precio" placeholder="Precio de Venta">
                </div>
                <div>
                    <h3>2. Receta Exacta</h3>
                    <div style="display:flex; gap:10px; align-items:center">
                        <select id="receta-select" style="flex:1" onchange="actualizarUnidadLabel()"></select>
                        <div style="position:relative; width:100px">
                            <input type="number" id="receta-cant" placeholder="Cant" style="width:100%; padding-right:35px">
                            <span id="lbl-unidad" style="position:absolute; right:8px; top:12px; font-size:0.75rem; color:var(--primary); font-weight:bold">und</span>
                        </div>
                        <button onclick="addIng()" style="width:auto; padding:0 15px; font-size:1.2rem">+</button>
                    </div>
                    <div id="lista-temp" style="margin-top:10px; max-height:150px; overflow-y:auto"></div>
                </div>
                <button class="primary" onclick="crearProducto()" style="grid-column:1/-1">CREAR PLATO</button>
            </div>
            <div class="glass-panel">
                <table><thead><tr><th>Plato</th><th>Precio</th></tr></thead><tbody id="tabla-productos"></tbody></table>
            </div>
        </div>

        <div id="sec-usuarios" class="section">
            <h1>Recursos Humanos</h1>
            <div class="glass-panel" style="max-width:400px">
                <input id="u-email" placeholder="Email">
                <input type="password" id="u-pass" placeholder="Contrase√±a">
                <input id="u-name" placeholder="Nombre">
                <select id="u-rol"><option value="mesero">Mesero</option><option value="cocinero">Cocinero</option><option value="cajero">Cajero</option><option value="admin">Admin</option></select>
                <button class="primary" onclick="crearUsuario()">REGISTRAR</button>
            </div>
            <div class="glass-panel">
                <table><thead><tr><th>Nombre</th><th>Email</th><th>Rol</th><th>Acciones</th></tr></thead><tbody id="tabla-usuarios"></tbody></table>
            </div>
        </div>

        <div id="sec-mesas" class="section">
            <h1>Sala</h1>
            <div class="glass-panel" style="display:flex; gap:10px; max-width:400px">
                <input id="m-nombre" placeholder="Nombre Mesa">
                <button class="primary" onclick="crearMesa()" style="width:auto; margin-top:0">CREAR</button>
            </div>
            <div class="glass-panel">
                <table><thead><tr><th>Mesa</th><th>Estado</th><th>Consumo</th><th>Acci√≥n</th></tr></thead><tbody id="tabla-mesas"></tbody></table>
            </div>
        </div>
    </div>

    <div id="qr-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="color:var(--primary)">Credencial de Acceso</h3>
            <div id="qrcode" style="display:flex; justify-content:center; margin:20px; background:white; padding:10px; border-radius:8px"></div>
            <p id="qr-info" style="font-size:0.9rem; margin-bottom:5px"></p>
            <p id="qr-pass-info" style="font-size:0.8rem; color:var(--text); opacity:0.7; margin-bottom:20px"></p>
            <div style="display:flex; gap:10px; justify-content:center">
                <button onclick="descargarCredencialPDF()" style="background:#10b981; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer">Descargar PDF</button>
                <button onclick="document.getElementById('qr-modal').style.display='none'" style="background:transparent; border:1px solid var(--glass-border); color:var(--text)">Cerrar</button>
            </div>
        </div>
    </div>

    <div class="theme-float" onclick="toggleThemeManual()"><span class="material-icons-round" id="theme-icon">light_mode</span></div>

    <script src="js/api.js"></script>
    <script>
        checkAuth();
        let insumos=[], recetaTemp=[], editId=null, currentQRUser={name:"",email:"",role:"",qrData:""};

        function initTheme(){if(localStorage.getItem('theme')==='light'){document.body.classList.add('light-mode');document.getElementById('theme-icon').innerText='dark_mode';}}
        function toggleThemeManual(){document.body.classList.toggle('light-mode');const isLight=document.body.classList.contains('light-mode');localStorage.setItem('theme',isLight?'light':'dark');document.getElementById('theme-icon').innerText=isLight?'dark_mode':'light_mode';}
        initTheme();

        function showToast(msg){
            const t=document.createElement('div'); t.className='toast'; t.innerHTML=`<span class="material-icons-round">check_circle</span>${msg}`;
            document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.remove(),3000);
        }

        let confirmCallback=null;
        function openConfirm(msg,cb){document.getElementById('confirm-msg').innerText=msg;confirmCallback=cb;document.getElementById('confirm-modal').style.display='flex';}
        function closeConfirm(){document.getElementById('confirm-modal').style.display='none';confirmCallback=null;}
        document.getElementById('btn-confirm-ok').onclick=()=>{if(confirmCallback)confirmCallback();closeConfirm();}

        function show(id){
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('sec-'+id).classList.add('active'); event.currentTarget.classList.add('active');
            if(id==='insumos')cargarInsumos(); if(id==='productos'){cargarInsumos();cargarProductos();} if(id==='usuarios')cargarUsuarios(); if(id==='mesas')cargarMesas();
        }

        // --- INVENTARIO ---
        async function cargarInsumos(){
            const r=await apiFetch('/insumos/');
            if(r){
                insumos=r.data;
                // Render Tabla
                document.getElementById('tabla-insumos').innerHTML=insumos.map(i=>{
                    const stock=i.stock_actual||0, max=i.stock_maximo||1000, pct=(stock/max)*100, isLow=pct<10;
                    return `<tr style="${isLow?'background:rgba(239,68,68,0.15);border-left:4px solid #ef4444':''}">
                        <td><b>${isLow?'‚ö†Ô∏è ':''}${i.nombre}</b></td>
                        <td>${stock} / ${max} ${i.unidad_medida}<div style="width:100%;height:4px;background:rgba(255,255,255,0.1);margin-top:5px;border-radius:2px"><div style="width:${Math.min(pct,100)}%;height:100%;background:${isLow?'#ef4444':'#10b981'};border-radius:2px"></div></div></td>
                        <td>$${i.costo}</td>
                        <td><button onclick="editIng('${i.id}')" style="background:none;color:var(--primary);border:none;cursor:pointer">Edit</button></td>
                    </tr>`;
                }).join('');
                
                // Render Select Receta (Con data-unidad para JS)
                const select = document.getElementById('receta-select');
                select.innerHTML=insumos.map(i=>`<option value="${i.id}" data-unidad="${i.unidad_medida}">${i.nombre}</option>`).join('');
                actualizarUnidadLabel(); // Actualizar el label inicial
            }
        }
        function editIng(id){const i=insumos.find(x=>x.id===id);editId=id;document.getElementById('i-nombre').value=i.nombre;document.getElementById('i-unidad').value=i.unidad_medida;document.getElementById('i-costo').value=i.costo;document.getElementById('i-stock').value=i.stock_actual;document.getElementById('i-max').value=i.stock_maximo;document.getElementById('btn-insumo').innerText="ACTUALIZAR";}
        async function guardarInsumo(){
            const p={nombre:document.getElementById('i-nombre').value,unidad_medida:document.getElementById('i-unidad').value,costo:document.getElementById('i-costo').value,stock_actual:document.getElementById('i-stock').value,stock_maximo:document.getElementById('i-max').value};
            let r; if(editId)r=await apiFetch(`/insumos/${editId}`,'PUT',p); else r=await apiFetch('/insumos/','POST',p);
            if(r){showToast("Guardado");cargarInsumos();editId=null;document.getElementById('btn-insumo').innerText="GUARDAR";document.getElementById('i-nombre').value='';}
        }

        // --- MEN√ö CON UNIDADES ---
        function actualizarUnidadLabel() {
            const select = document.getElementById('receta-select');
            const option = select.options[select.selectedIndex];
            if (option) {
                const unidad = option.getAttribute('data-unidad');
                document.getElementById('lbl-unidad').innerText = unidad || 'und';
            }
        }

        function addIng(){
            const s=document.getElementById('receta-select'), c=document.getElementById('receta-cant').value;
            const unidad = s.options[s.selectedIndex].getAttribute('data-unidad');
            if(!c)return; 
            recetaTemp.push({insumo_id:s.value,cantidad_requerida:c,nombre:s.options[s.selectedIndex].text, unidad: unidad});
            document.getElementById('receta-cant').value=''; renderReceta();
        }
        function delIng(i){recetaTemp.splice(i,1);renderReceta();}
        function renderReceta(){document.getElementById('lista-temp').innerHTML=recetaTemp.map((r,i)=>`<div class="ing-item"><span>${r.nombre} (${r.cantidad_requerida}${r.unidad})</span><span style="color:var(--danger);cursor:pointer" onclick="delIng(${i})">‚úï</span></div>`).join('');}
        async function crearProducto(){
            if(!document.getElementById('p-nombre').value)return;
            const r=await apiFetch('/productos/','POST',{nombre:document.getElementById('p-nombre').value,precio:document.getElementById('p-precio').value,ingredientes:recetaTemp});
            if(r){showToast("Plato Creado");cargarProductos();recetaTemp=[];renderReceta();document.getElementById('p-nombre').value='';}
        }
        async function cargarProductos(){const r=await apiFetch('/productos/');if(r)document.getElementById('tabla-productos').innerHTML=r.data.map(p=>`<tr><td>${p.nombre}</td><td>$${p.precio}</td></tr>`).join('');}

        // --- USUARIOS ---
        async function crearUsuario(){
            const em=document.getElementById('u-email').value;
            const pass=document.getElementById('u-pass').value;
            const name=document.getElementById('u-name').value;
            const rol=document.getElementById('u-rol').value;
            const r=await apiFetch('/users/','POST',{email:em,password:pass,full_name:name,rol:rol});
            if(r){showToast("Usuario Creado");mostrarModalQR(name,em,rol,pass);cargarUsuarios();document.getElementById('u-email').value='';document.getElementById('u-pass').value='';document.getElementById('u-name').value='';}
        }
        async function cargarUsuarios(){
            const r=await apiFetch('/users/');
            if(r){document.getElementById('tabla-usuarios').innerHTML=r.data.map(u=>`<tr><td>${u.full_name}</td><td>${u.email}</td><td><span style="color:var(--primary)">${u.rol||'admin'}</span></td><td style="display:flex;gap:10px"><button onclick="verQRExistente('${u.full_name}','${u.email}','${u.rol}')" style="background:none;border:1px solid var(--glass-border);padding:5px;border-radius:6px;cursor:pointer;color:var(--text)">ü™™ QR</button><button onclick="borrarUsuario('${u.id}')" style="background:none;border:none;color:var(--danger);cursor:pointer"><span class="material-icons-round">delete</span></button></td></tr>`).join('');}
        }
        async function borrarUsuario(id){openConfirm("¬øEliminar usuario?",async()=>{await apiFetch(`/users/${id}`,'DELETE');showToast("Eliminado");cargarUsuarios();});}
        function verQRExistente(name,email,role){mostrarModalQR(name,email,role,null);}
        function mostrarModalQR(name,email,role,pass){
            const container=document.getElementById('qrcode');container.innerHTML='';
            const urlLogin=`${window.location.origin}/frontend/login.html?user=${encodeURIComponent(email)}`;
            new QRCode(container,{text:urlLogin,width:150,height:150});
            document.getElementById('qr-info').innerHTML=`<b>${name}</b><br>${email} - ${role.toUpperCase()}`;
            document.getElementById('qr-pass-info').innerText=pass?`Pass: ${pass}`:"Pass: (Oculta)";
            currentQRUser={name,email,role,qrData:urlLogin};
            document.getElementById('qr-modal').style.display='flex';
        }
        function descargarCredencialPDF(){
            const {jsPDF}=window.jspdf;
            const doc=new jsPDF({orientation:"portrait",unit:"mm",format:[55,85]});
            const pageWidth=doc.internal.pageSize.getWidth(),centerX=pageWidth/2;
            doc.setFillColor(30,41,59);doc.rect(0,0,pageWidth,85,"F");
            doc.setTextColor(255,255,255);doc.setFontSize(10);doc.setFont("helvetica","bold");doc.text("GASTRO POS",centerX,10,{align:"center"});
            doc.setFontSize(6);doc.setFont("helvetica","normal");doc.text("CREDENCIAL DE ACCESO",centerX,14,{align:"center"});
            const qrSize=35,qrY=20;const tempDiv=document.createElement('div');
            new QRCode(tempDiv,{text:currentQRUser.qrData,width:200,height:200,correctLevel:QRCode.CorrectLevel.H});
            const qrCanvas=tempDiv.querySelector('canvas');
            if(qrCanvas){
                doc.setFillColor(255,255,255);doc.rect(centerX-(qrSize/2)-1,qrY-1,qrSize+2,qrSize+2,"F");
                doc.addImage(qrCanvas.toDataURL("image/png"),'PNG',centerX-(qrSize/2),qrY,qrSize,qrSize);
            }
            doc.setTextColor(255,255,255);doc.setFontSize(11);doc.setFont("helvetica","bold");
            const nm=doc.splitTextToSize(currentQRUser.name,pageWidth-10);doc.text(nm,centerX,65,{align:"center"});
            doc.setFontSize(8);doc.setFont("helvetica","normal");doc.text(currentQRUser.role.toUpperCase(),centerX,72,{align:"center"});
            doc.setFontSize(6);doc.setTextColor(200,200,200);
            const em=doc.splitTextToSize(currentQRUser.email,pageWidth-6);doc.text(em,centerX,77,{align:"center"});
            doc.save(`Credencial_${currentQRUser.name.replace(/\s+/g,'_')}.pdf`);
        }

        // --- MESAS ---
        async function cargarMesas(){
            const rm=await apiFetch('/mesas/'), rv=await apiFetch('/ventas/');
            if(rm&&rv){
                const act=(rv.data||rv).filter(v=>v.estado!=='pagado'&&v.estado!=='cerrado_split');
                document.getElementById('tabla-mesas').innerHTML=rm.data.map(m=>{
                    const v=act.find(x=>x.mesa===m.nombre);
                    return `<tr><td><b>${m.nombre}</b></td><td>${v?'<span class="badge" style="background:rgba(239,68,68,0.2);color:#ef4444">OCUPADA</span>':'<span class="badge" style="background:rgba(16,185,129,0.2);color:#10b981">LIBRE</span>'}</td><td>${v?`$${v.total.toLocaleString()}`:'-'}</td><td><button onclick="delMesa('${m.id}')" style="background:none;border:none;color:var(--danger);cursor:pointer">Eliminar</button></td></tr>`;
                }).join('');
            }
        }
        async function crearMesa(){const n=document.getElementById('m-nombre').value;if(!n)return;const r=await apiFetch('/mesas/','POST',{nombre:n});if(r){showToast("Mesa creada");document.getElementById('m-nombre').value='';cargarMesas();}}
        async function delMesa(id){openConfirm("¬øEliminar mesa?",async()=>{await apiFetch(`/mesas/${id}`,'DELETE');cargarMesas();});}

        function logout(){localStorage.clear();window.location.href='login.html';}
        show('insumos');
    </script>
</body>
</html>