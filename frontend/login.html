<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - GastroPOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root { --bg: #f9fafb; --card: #ffffff; --text: #101828; --brand: #465fff; }
        [data-theme="dark"] { --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; }
        
        body { font-family: 'Outfit', sans-serif; background: var(--bg); height: 100vh; display: flex; justify-content: center; align-items: center; margin: 0; color: var(--text); }
        .card { background: var(--card); padding: 40px; width: 380px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); text-align: center; }
        input { width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--brand); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        button:hover { opacity: 0.9; }
        .error { color: #f04438; font-size: 13px; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <div class="card">
        <h1>üçΩÔ∏è GastroPOS</h1>
        <p>Inicia sesi√≥n para continuar</p>
        
        <input type="text" id="email" placeholder="admin@example.com">
        <input type="password" id="password" placeholder="Contrase√±a">
        
        <button onclick="login()">INGRESAR</button>
        <p id="error-msg" class="error"></p>
    </div>

    <script>
        // URL correcta de tu Backend
        const API_URL = "http://127.0.0.1:8000/api/v1";

        async function login() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('error-msg');
            
            errorMsg.style.display = 'none';

            if (!email || !password) {
                mostrarError("Por favor completa los campos");
                return;
            }

            try {
                // 1. Obtener Token (Formato x-www-form-urlencoded)
                const formData = new URLSearchParams();
                formData.append('username', email);
                formData.append('password', password);

                const res = await fetch(`${API_URL}/login/access-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (!res.ok) throw new Error("Credenciales incorrectas");

                const data = await res.json();
                const token = data.access_token;
                
                // Guardar Token
                localStorage.setItem('token', token);

                // 2. Obtener Rol del Usuario
                const userRes = await fetch(`${API_URL}/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await userRes.json();

                // Guardar datos b√°sicos para el POS
                const role = user.is_superuser ? 'admin' : (user.rol || 'mesero');
                localStorage.setItem('user_role', role);
                localStorage.setItem('user_name', user.full_name || user.email);
                
                // IMPORTANTE: Guardamos este objeto para compatibilidad con c√≥digo antiguo si queda alguno
                localStorage.setItem('gastro_user', JSON.stringify({
                    username: user.full_name,
                    email: user.email,
                    rol: role
                }));

                // 3. Redirigir
                if (role === 'admin') window.location.href = 'admin.html';
                else if (role === 'cocinero') window.location.href = 'cocina.html';
                else if (role === 'cajero') window.location.href = 'caja.html';
                else window.location.href = 'pos.html'; // Meseros

            } catch (error) {
                console.error(error);
                mostrarError("Error: " + error.message);
            }
        }

        function mostrarError(msg) {
            const e = document.getElementById('error-msg');
            e.innerText = msg;
            e.style.display = 'block';
        }
    </script>
</body>
</html>